/*
 * VPDB - Virtual Pinball Database
 * Copyright (C) 2019 freezy <freezy@vpdb.io>
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */

const ApiClient = require('../../test/api.client');
const ThreeHelper = require('../../test/three.helper');

const api = new ApiClient();
const three = new ThreeHelper(api);

describe.only('The VPinball ramp parser', () => {

	let vpxFile, gltf;

	before(async () => {
		await api.setupUsers({
			member: { roles: ['member'] },
		});
		vpxFile = await api.fileHelper.createVpx('member', 'table-ramp.vpx');
		gltf = await three.loadGlb('member', vpxFile.variations.gltf);
	});

	after(async () => {
		await api.teardown();
	});

	it('should generate a flat ramp mesh', async () => {
		const vertices = concatMeshes(gltf, ['rampfloor-Flat', 'rampleft-Flat', 'rampright-Flat']);
		let expectedVertices = [
			[217.559097, 1201.483398, -0.000000],
			[125.305038, 1240.588623, -0.000000],
			[214.102509, 1194.188354, -0.871972],
			[123.078362, 1234.476196, -0.871972],
			[209.490326, 1185.186035, -1.929441],
			[120.294624, 1227.441650, -1.929441],
			[199.099182, 1165.977661, -4.520071],
			[111.789703, 1207.730103, -4.520071],
			[186.590118, 1143.536255, -7.606925],
			[101.653778, 1183.859741, -7.606925],
			[180.011688, 1131.317139, -9.284492],
			[96.150055, 1170.802002, -9.284492],
			[173.473389, 1118.900269, -11.023962],
			[90.444427, 1156.875366, -11.023962],
			[167.041824, 1106.226563, -12.804964],
			[84.728775, 1142.399170, -12.804964],
			[160.877533, 1093.588135, -14.607404],
			[79.101013, 1127.342041, -14.607404],
			[155.039993, 1080.962891, -16.411638],
			[73.760193, 1111.986084, -16.411638],
			[149.653229, 1068.406738, -18.198559],
			[68.840759, 1096.536133, -18.198559],
			[144.892715, 1056.216919, -19.949841],
			[64.425705, 1080.955444, -19.949841],
			[140.859619, 1044.579346, -21.648264],
			[60.672371, 1065.318359, -21.648264],
			[137.675980, 1033.732178, -23.278139],
			[57.717197, 1049.647217, -23.278139],
			[135.402344, 1023.840576, -24.826042],
			[55.758125, 1034.037109, -24.826042],
			[133.849121, 1013.646423, -26.386383],
			[54.960201, 1018.279236, -26.386383],
			[132.875122, 1002.148376, -28.032291],
			[55.188202, 1002.300110, -28.032291],
			[132.479736, 989.552795, -29.749880],
			[56.256248, 986.219177, -29.749880],
			[132.632233, 976.128662, -31.522974],
			[58.008572, 970.093262, -31.522974],
			[133.270065, 962.129822, -33.333839],
			[60.321274, 953.994202, -33.333839],
			[134.330276, 947.788391, -35.163628],
			[63.070786, 938.015930, -35.163628],
			[135.747101, 933.266479, -36.992722],
			[66.136421, 922.321899, -36.992722],
			[137.419571, 918.799500, -38.800930],
			[69.432632, 907.002625, -38.800930],
			[139.287262, 904.546265, -40.567661],
			[72.833382, 892.224976, -40.567661],
			[141.219818, 890.840576, -42.271992],
			[76.282547, 877.981079, -42.271992],
			[145.183640, 864.536621, -45.408825],
			[82.676056, 852.932739, -45.408825],
			[148.473923, 842.826294, -48.041199],
			[87.958397, 831.525269, -48.041199],
			[149.753815, 833.244385, -49.115154],
			[89.829353, 823.450684, -49.115154],
			[150.546387, 825.392334, -50.000000],
			[91.181999, 816.682007, -50.000000],
			[217.559097, 1201.483398, -0.000000],
			[217.559097, 1201.483398, -30.000000],
			[214.102509, 1194.188354, -0.871972],
			[214.102509, 1194.188354, -30.871971],
			[209.490326, 1185.186035, -1.929441],
			[209.490326, 1185.186035, -31.929441],
			[199.099182, 1165.977661, -4.520071],
			[199.099182, 1165.977661, -34.520073],
			[186.590118, 1143.536255, -7.606925],
			[186.590118, 1143.536255, -37.606926],
			[180.011688, 1131.317139, -9.284492],
			[180.011688, 1131.317139, -39.284492],
			[173.473389, 1118.900269, -11.023962],
			[173.473389, 1118.900269, -41.023964],
			[167.041824, 1106.226563, -12.804964],
			[167.041824, 1106.226563, -42.804962],
			[160.877533, 1093.588135, -14.607404],
			[160.877533, 1093.588135, -44.607403],
			[155.039993, 1080.962891, -16.411638],
			[155.039993, 1080.962891, -46.411636],
			[149.653229, 1068.406738, -18.198559],
			[149.653229, 1068.406738, -48.198559],
			[144.892715, 1056.216919, -19.949841],
			[144.892715, 1056.216919, -49.949841],
			[140.859619, 1044.579346, -21.648264],
			[140.859619, 1044.579346, -51.648262],
			[137.675980, 1033.732178, -23.278139],
			[137.675980, 1033.732178, -53.278137],
			[135.402344, 1023.840576, -24.826042],
			[135.402344, 1023.840576, -54.826042],
			[133.849121, 1013.646423, -26.386383],
			[133.849121, 1013.646423, -56.386383],
			[132.875122, 1002.148376, -28.032291],
			[132.875122, 1002.148376, -58.032291],
			[132.479736, 989.552795, -29.749880],
			[132.479736, 989.552795, -59.749878],
			[132.632233, 976.128662, -31.522974],
			[132.632233, 976.128662, -61.522972],
			[133.270065, 962.129822, -33.333839],
			[133.270065, 962.129822, -63.333839],
			[134.330276, 947.788391, -35.163628],
			[134.330276, 947.788391, -65.163628],
			[135.747101, 933.266479, -36.992722],
			[135.747101, 933.266479, -66.992722],
			[137.419571, 918.799500, -38.800930],
			[137.419571, 918.799500, -68.800934],
			[139.287262, 904.546265, -40.567661],
			[139.287262, 904.546265, -70.567657],
			[141.219818, 890.840576, -42.271992],
			[141.219818, 890.840576, -72.271988],
			[145.183640, 864.536621, -45.408825],
			[145.183640, 864.536621, -75.408829],
			[148.473923, 842.826294, -48.041199],
			[148.473923, 842.826294, -78.041199],
			[149.753815, 833.244385, -49.115154],
			[149.753815, 833.244385, -79.115158],
			[150.546387, 825.392334, -50.000000],
			[150.546387, 825.392334, -80.000000],
			[125.305038, 1240.588623, -0.000000],
			[125.305038, 1240.588623, -30.000000],
			[123.078362, 1234.476196, -0.871972],
			[123.078362, 1234.476196, -30.871971],
			[120.294624, 1227.441650, -1.929441],
			[120.294624, 1227.441650, -31.929441],
			[111.789703, 1207.730103, -4.520071],
			[111.789703, 1207.730103, -34.520073],
			[101.653778, 1183.859741, -7.606925],
			[101.653778, 1183.859741, -37.606926],
			[96.150055, 1170.802002, -9.284492],
			[96.150055, 1170.802002, -39.284492],
			[90.444427, 1156.875366, -11.023962],
			[90.444427, 1156.875366, -41.023964],
			[84.728775, 1142.399170, -12.804964],
			[84.728775, 1142.399170, -42.804962],
			[79.101013, 1127.342041, -14.607404],
			[79.101013, 1127.342041, -44.607403],
			[73.760193, 1111.986084, -16.411638],
			[73.760193, 1111.986084, -46.411636],
			[68.840759, 1096.536133, -18.198559],
			[68.840759, 1096.536133, -48.198559],
			[64.425705, 1080.955444, -19.949841],
			[64.425705, 1080.955444, -49.949841],
			[60.672371, 1065.318359, -21.648264],
			[60.672371, 1065.318359, -51.648262],
			[57.717197, 1049.647217, -23.278139],
			[57.717197, 1049.647217, -53.278137],
			[55.758125, 1034.037109, -24.826042],
			[55.758125, 1034.037109, -54.826042],
			[54.960201, 1018.279236, -26.386383],
			[54.960201, 1018.279236, -56.386383],
			[55.188202, 1002.300110, -28.032291],
			[55.188202, 1002.300110, -58.032291],
			[56.256248, 986.219177, -29.749880],
			[56.256248, 986.219177, -59.749878],
			[58.008572, 970.093262, -31.522974],
			[58.008572, 970.093262, -61.522972],
			[60.321274, 953.994202, -33.333839],
			[60.321274, 953.994202, -63.333839],
			[63.070786, 938.015930, -35.163628],
			[63.070786, 938.015930, -65.163628],
			[66.136421, 922.321899, -36.992722],
			[66.136421, 922.321899, -66.992722],
			[69.432632, 907.002625, -38.800930],
			[69.432632, 907.002625, -68.800934],
			[72.833382, 892.224976, -40.567661],
			[72.833382, 892.224976, -70.567657],
			[76.282547, 877.981079, -42.271992],
			[76.282547, 877.981079, -72.271988],
			[82.676056, 852.932739, -45.408825],
			[82.676056, 852.932739, -75.408829],
			[87.958397, 831.525269, -48.041199],
			[87.958397, 831.525269, -78.041199],
			[89.829353, 823.450684, -49.115154],
			[89.829353, 823.450684, -79.115158],
			[91.181999, 816.682007, -50.000000],
			[91.181999, 816.682007, -80.000000],
		];
		three.expectVerticesInArray(expectedVertices, vertices, 2);
	});

	it('should generate a flat ramp mesh with only left wall', async () => {
		three.expectNoObject(gltf, 'ramps', 'rampright-FlatL');
		const vertices = concatMeshes(gltf, ['rampfloor-FlatL', 'rampleft-FlatL']);
		let expectedVertices = [
			[353.603241, 1076.285522, -0.000000],
			[280.025848, 1090.824097, -0.000000],
			[350.920929, 1060.276978, -1.733521],
			[276.615814, 1076.000122, -1.733521],
			[346.749695, 1038.770874, -3.866442],
			[271.621033, 1056.555786, -3.866442],
			[342.096497, 1014.742554, -6.388787],
			[265.256531, 1031.836304, -6.388787],
			[337.232361, 988.123840, -9.290064],
			[258.473267, 1004.230896, -9.290064],
			[334.917755, 974.324585, -10.879847],
			[255.109879, 989.589844, -10.879847],
			[332.769592, 960.310791, -12.561075],
			[251.880920, 974.664551, -12.561075],
			[330.871338, 946.411682, -14.333026],
			[248.855576, 959.415833, -14.333026],
			[329.287872, 932.751709, -16.195255],
			[246.121796, 944.009521, -16.195255],
			[328.074585, 919.437805, -18.147734],
			[243.776840, 928.628601, -18.147734],
			[327.300812, 906.713440, -20.190956],
			[241.904266, 913.320007, -20.190956],
			[327.019958, 894.927429, -22.326214],
			[240.603317, 898.024719, -22.326214],
			[327.255798, 884.088867, -24.555868],
			[240.003006, 883.024048, -24.555868],
			[328.074585, 873.023132, -27.072788],
			[240.191849, 867.655823, -27.072788],
			[329.502686, 860.917053, -29.934511],
			[241.072632, 851.989441, -29.934511],
			[331.479645, 848.058777, -33.087601],
			[242.539337, 836.041931, -33.087601],
			[333.949890, 834.555237, -36.477451],
			[244.481018, 820.011658, -36.477451],
			[336.847748, 820.650635, -40.048634],
			[246.796661, 803.959717, -40.048634],
			[340.045044, 806.530029, -43.745193],
			[249.448059, 788.005981, -43.745193],
			[343.531494, 792.294434, -47.510719],
			[252.278793, 772.354858, -47.510719],
			[347.144653, 778.384949, -51.288525],
			[255.284912, 756.870422, -51.288525],
			[354.521484, 751.157104, -58.653107],
			[261.386475, 728.009644, -58.653107],
			[361.559296, 725.796631, -65.381996],
			[267.036591, 702.915039, -65.381996],
			[367.692810, 704.637146, -71.016884],
			[271.468201, 681.694885, -71.016884],
			[371.886475, 688.113403, -75.099998],
			[274.384521, 666.356201, -75.099998],
			[353.603241, 1076.285522, -0.000000],
			[353.603241, 1076.285522, -0.000000],
			[350.920929, 1060.276978, -1.733521],
			[350.920929, 1060.276978, -1.733521],
			[346.749695, 1038.770874, -3.866442],
			[346.749695, 1038.770874, -3.866442],
			[342.096497, 1014.742554, -6.388787],
			[342.096497, 1014.742554, -6.388787],
			[337.232361, 988.123840, -9.290064],
			[337.232361, 988.123840, -9.290064],
			[334.917755, 974.324585, -10.879847],
			[334.917755, 974.324585, -10.879847],
			[332.769592, 960.310791, -12.561075],
			[332.769592, 960.310791, -12.561075],
			[330.871338, 946.411682, -14.333026],
			[330.871338, 946.411682, -14.333026],
			[329.287872, 932.751709, -16.195255],
			[329.287872, 932.751709, -16.195255],
			[328.074585, 919.437805, -18.147734],
			[328.074585, 919.437805, -18.147734],
			[327.300812, 906.713440, -20.190956],
			[327.300812, 906.713440, -20.190956],
			[327.019958, 894.927429, -22.326214],
			[327.019958, 894.927429, -22.326214],
			[327.255798, 884.088867, -24.555868],
			[327.255798, 884.088867, -24.555868],
			[328.074585, 873.023132, -27.072788],
			[328.074585, 873.023132, -27.072788],
			[329.502686, 860.917053, -29.934511],
			[329.502686, 860.917053, -29.934511],
			[331.479645, 848.058777, -33.087601],
			[331.479645, 848.058777, -33.087601],
			[333.949890, 834.555237, -36.477451],
			[333.949890, 834.555237, -36.477451],
			[336.847748, 820.650635, -40.048634],
			[336.847748, 820.650635, -40.048634],
			[340.045044, 806.530029, -43.745193],
			[340.045044, 806.530029, -43.745193],
			[343.531494, 792.294434, -47.510719],
			[343.531494, 792.294434, -47.510719],
			[347.144653, 778.384949, -51.288525],
			[347.144653, 778.384949, -51.288525],
			[354.521484, 751.157104, -58.653107],
			[354.521484, 751.157104, -58.653107],
			[361.559296, 725.796631, -65.381996],
			[361.559296, 725.796631, -65.381996],
			[367.692810, 704.637146, -71.016884],
			[367.692810, 704.637146, -71.016884],
			[371.886475, 688.113403, -75.099998],
			[371.886475, 688.113403, -75.099998],
			[280.025848, 1090.824097, -0.000000],
			[280.025848, 1090.824097, -35.000000],
			[276.615814, 1076.000122, -1.733521],
			[276.615814, 1076.000122, -36.733521],
			[271.621033, 1056.555786, -3.866442],
			[271.621033, 1056.555786, -38.866440],
			[265.256531, 1031.836304, -6.388787],
			[265.256531, 1031.836304, -41.388786],
			[258.473267, 1004.230896, -9.290064],
			[258.473267, 1004.230896, -44.290062],
			[255.109879, 989.589844, -10.879847],
			[255.109879, 989.589844, -45.879845],
			[251.880920, 974.664551, -12.561075],
			[251.880920, 974.664551, -47.561073],
			[248.855576, 959.415833, -14.333026],
			[248.855576, 959.415833, -49.333027],
			[246.121796, 944.009521, -16.195255],
			[246.121796, 944.009521, -51.195255],
			[243.776840, 928.628601, -18.147734],
			[243.776840, 928.628601, -53.147736],
			[241.904266, 913.320007, -20.190956],
			[241.904266, 913.320007, -55.190956],
			[240.603317, 898.024719, -22.326214],
			[240.603317, 898.024719, -57.326214],
			[240.003006, 883.024048, -24.555868],
			[240.003006, 883.024048, -59.555870],
			[240.191849, 867.655823, -27.072788],
			[240.191849, 867.655823, -62.072788],
			[241.072632, 851.989441, -29.934511],
			[241.072632, 851.989441, -64.934509],
			[242.539337, 836.041931, -33.087601],
			[242.539337, 836.041931, -68.087601],
			[244.481018, 820.011658, -36.477451],
			[244.481018, 820.011658, -71.477448],
			[246.796661, 803.959717, -40.048634],
			[246.796661, 803.959717, -75.048630],
			[249.448059, 788.005981, -43.745193],
			[249.448059, 788.005981, -78.745193],
			[252.278793, 772.354858, -47.510719],
			[252.278793, 772.354858, -82.510719],
			[255.284912, 756.870422, -51.288525],
			[255.284912, 756.870422, -86.288528],
			[261.386475, 728.009644, -58.653107],
			[261.386475, 728.009644, -93.653107],
			[267.036591, 702.915039, -65.381996],
			[267.036591, 702.915039, -100.381996],
			[271.468201, 681.694885, -71.016884],
			[271.468201, 681.694885, -106.016884],
			[274.384521, 666.356201, -75.099998],
			[274.384521, 666.356201, -110.099998],
		];
		three.expectVerticesInArray(expectedVertices, vertices);
	});
});

function concatMeshes(gltf, objectNames) {
	const arr = [];
	for (const objName of objectNames) {
		const mesh = three.find(gltf, 'ramps', objName);
		arr.push(...mesh.geometry.attributes.position.array);
	}
	return arr;
}