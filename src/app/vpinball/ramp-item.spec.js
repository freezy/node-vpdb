/*
 * VPDB - Virtual Pinball Database
 * Copyright (C) 2019 freezy <freezy@vpdb.io>
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */

const ApiClient = require('../../test/api.client');
const ThreeHelper = require('../../test/three.helper');

const api = new ApiClient();
const three = new ThreeHelper(api);

describe.only('The VPinball ramp parser', () => {

	let vpxFile, gltf;

	before(async () => {
		await api.setupUsers({
			member: { roles: ['member'] },
		});
		vpxFile = await api.fileHelper.createVpx('member', 'table-ramp.vpx');
		gltf = await three.loadGlb('member', vpxFile.variations.gltf);
	});

	after(async () => {
		await api.teardown();
	});

	it('should generate a flat ramp mesh', async () => {
		const vertices = concatMeshes(gltf, ['rampfloor-Flat', 'rampleft-Flat', 'rampright-Flat']);
		let expectedVertices = [
			[217.559097, 1201.483398, -0.000000],
			[125.305038, 1240.588623, -0.000000],
			[214.102509, 1194.188354, -0.871972],
			[123.078362, 1234.476196, -0.871972],
			[209.490326, 1185.186035, -1.929441],
			[120.294624, 1227.441650, -1.929441],
			[199.099182, 1165.977661, -4.520071],
			[111.789703, 1207.730103, -4.520071],
			[186.590118, 1143.536255, -7.606925],
			[101.653778, 1183.859741, -7.606925],
			[180.011688, 1131.317139, -9.284492],
			[96.150055, 1170.802002, -9.284492],
			[173.473389, 1118.900269, -11.023962],
			[90.444427, 1156.875366, -11.023962],
			[167.041824, 1106.226563, -12.804964],
			[84.728775, 1142.399170, -12.804964],
			[160.877533, 1093.588135, -14.607404],
			[79.101013, 1127.342041, -14.607404],
			[155.039993, 1080.962891, -16.411638],
			[73.760193, 1111.986084, -16.411638],
			[149.653229, 1068.406738, -18.198559],
			[68.840759, 1096.536133, -18.198559],
			[144.892715, 1056.216919, -19.949841],
			[64.425705, 1080.955444, -19.949841],
			[140.859619, 1044.579346, -21.648264],
			[60.672371, 1065.318359, -21.648264],
			[137.675980, 1033.732178, -23.278139],
			[57.717197, 1049.647217, -23.278139],
			[135.402344, 1023.840576, -24.826042],
			[55.758125, 1034.037109, -24.826042],
			[133.849121, 1013.646423, -26.386383],
			[54.960201, 1018.279236, -26.386383],
			[132.875122, 1002.148376, -28.032291],
			[55.188202, 1002.300110, -28.032291],
			[132.479736, 989.552795, -29.749880],
			[56.256248, 986.219177, -29.749880],
			[132.632233, 976.128662, -31.522974],
			[58.008572, 970.093262, -31.522974],
			[133.270065, 962.129822, -33.333839],
			[60.321274, 953.994202, -33.333839],
			[134.330276, 947.788391, -35.163628],
			[63.070786, 938.015930, -35.163628],
			[135.747101, 933.266479, -36.992722],
			[66.136421, 922.321899, -36.992722],
			[137.419571, 918.799500, -38.800930],
			[69.432632, 907.002625, -38.800930],
			[139.287262, 904.546265, -40.567661],
			[72.833382, 892.224976, -40.567661],
			[141.219818, 890.840576, -42.271992],
			[76.282547, 877.981079, -42.271992],
			[145.183640, 864.536621, -45.408825],
			[82.676056, 852.932739, -45.408825],
			[148.473923, 842.826294, -48.041199],
			[87.958397, 831.525269, -48.041199],
			[149.753815, 833.244385, -49.115154],
			[89.829353, 823.450684, -49.115154],
			[150.546387, 825.392334, -50.000000],
			[91.181999, 816.682007, -50.000000],
			[217.559097, 1201.483398, -0.000000],
			[217.559097, 1201.483398, -30.000000],
			[214.102509, 1194.188354, -0.871972],
			[214.102509, 1194.188354, -30.871971],
			[209.490326, 1185.186035, -1.929441],
			[209.490326, 1185.186035, -31.929441],
			[199.099182, 1165.977661, -4.520071],
			[199.099182, 1165.977661, -34.520073],
			[186.590118, 1143.536255, -7.606925],
			[186.590118, 1143.536255, -37.606926],
			[180.011688, 1131.317139, -9.284492],
			[180.011688, 1131.317139, -39.284492],
			[173.473389, 1118.900269, -11.023962],
			[173.473389, 1118.900269, -41.023964],
			[167.041824, 1106.226563, -12.804964],
			[167.041824, 1106.226563, -42.804962],
			[160.877533, 1093.588135, -14.607404],
			[160.877533, 1093.588135, -44.607403],
			[155.039993, 1080.962891, -16.411638],
			[155.039993, 1080.962891, -46.411636],
			[149.653229, 1068.406738, -18.198559],
			[149.653229, 1068.406738, -48.198559],
			[144.892715, 1056.216919, -19.949841],
			[144.892715, 1056.216919, -49.949841],
			[140.859619, 1044.579346, -21.648264],
			[140.859619, 1044.579346, -51.648262],
			[137.675980, 1033.732178, -23.278139],
			[137.675980, 1033.732178, -53.278137],
			[135.402344, 1023.840576, -24.826042],
			[135.402344, 1023.840576, -54.826042],
			[133.849121, 1013.646423, -26.386383],
			[133.849121, 1013.646423, -56.386383],
			[132.875122, 1002.148376, -28.032291],
			[132.875122, 1002.148376, -58.032291],
			[132.479736, 989.552795, -29.749880],
			[132.479736, 989.552795, -59.749878],
			[132.632233, 976.128662, -31.522974],
			[132.632233, 976.128662, -61.522972],
			[133.270065, 962.129822, -33.333839],
			[133.270065, 962.129822, -63.333839],
			[134.330276, 947.788391, -35.163628],
			[134.330276, 947.788391, -65.163628],
			[135.747101, 933.266479, -36.992722],
			[135.747101, 933.266479, -66.992722],
			[137.419571, 918.799500, -38.800930],
			[137.419571, 918.799500, -68.800934],
			[139.287262, 904.546265, -40.567661],
			[139.287262, 904.546265, -70.567657],
			[141.219818, 890.840576, -42.271992],
			[141.219818, 890.840576, -72.271988],
			[145.183640, 864.536621, -45.408825],
			[145.183640, 864.536621, -75.408829],
			[148.473923, 842.826294, -48.041199],
			[148.473923, 842.826294, -78.041199],
			[149.753815, 833.244385, -49.115154],
			[149.753815, 833.244385, -79.115158],
			[150.546387, 825.392334, -50.000000],
			[150.546387, 825.392334, -80.000000],
			[125.305038, 1240.588623, -0.000000],
			[125.305038, 1240.588623, -30.000000],
			[123.078362, 1234.476196, -0.871972],
			[123.078362, 1234.476196, -30.871971],
			[120.294624, 1227.441650, -1.929441],
			[120.294624, 1227.441650, -31.929441],
			[111.789703, 1207.730103, -4.520071],
			[111.789703, 1207.730103, -34.520073],
			[101.653778, 1183.859741, -7.606925],
			[101.653778, 1183.859741, -37.606926],
			[96.150055, 1170.802002, -9.284492],
			[96.150055, 1170.802002, -39.284492],
			[90.444427, 1156.875366, -11.023962],
			[90.444427, 1156.875366, -41.023964],
			[84.728775, 1142.399170, -12.804964],
			[84.728775, 1142.399170, -42.804962],
			[79.101013, 1127.342041, -14.607404],
			[79.101013, 1127.342041, -44.607403],
			[73.760193, 1111.986084, -16.411638],
			[73.760193, 1111.986084, -46.411636],
			[68.840759, 1096.536133, -18.198559],
			[68.840759, 1096.536133, -48.198559],
			[64.425705, 1080.955444, -19.949841],
			[64.425705, 1080.955444, -49.949841],
			[60.672371, 1065.318359, -21.648264],
			[60.672371, 1065.318359, -51.648262],
			[57.717197, 1049.647217, -23.278139],
			[57.717197, 1049.647217, -53.278137],
			[55.758125, 1034.037109, -24.826042],
			[55.758125, 1034.037109, -54.826042],
			[54.960201, 1018.279236, -26.386383],
			[54.960201, 1018.279236, -56.386383],
			[55.188202, 1002.300110, -28.032291],
			[55.188202, 1002.300110, -58.032291],
			[56.256248, 986.219177, -29.749880],
			[56.256248, 986.219177, -59.749878],
			[58.008572, 970.093262, -31.522974],
			[58.008572, 970.093262, -61.522972],
			[60.321274, 953.994202, -33.333839],
			[60.321274, 953.994202, -63.333839],
			[63.070786, 938.015930, -35.163628],
			[63.070786, 938.015930, -65.163628],
			[66.136421, 922.321899, -36.992722],
			[66.136421, 922.321899, -66.992722],
			[69.432632, 907.002625, -38.800930],
			[69.432632, 907.002625, -68.800934],
			[72.833382, 892.224976, -40.567661],
			[72.833382, 892.224976, -70.567657],
			[76.282547, 877.981079, -42.271992],
			[76.282547, 877.981079, -72.271988],
			[82.676056, 852.932739, -45.408825],
			[82.676056, 852.932739, -75.408829],
			[87.958397, 831.525269, -48.041199],
			[87.958397, 831.525269, -78.041199],
			[89.829353, 823.450684, -49.115154],
			[89.829353, 823.450684, -79.115158],
			[91.181999, 816.682007, -50.000000],
			[91.181999, 816.682007, -80.000000],
		];
		three.expectVerticesInArray(expectedVertices, vertices, 2);
	});
});

function concatMeshes(gltf, objectNames) {
	const arr = [];
	for (const objName of objectNames) {
		const mesh = three.find(gltf, 'ramps', objName);
		arr.push(...mesh.geometry.attributes.position.array);
	}
	return arr;
}